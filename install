#!/usr/bin/env bash

set -e

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKUP_DIR="$HOME/.dotfiles-backup-$(date +%Y%m%d_%H%M%S)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper functions
e_header() { echo -e "${BLUE}==>${NC} $1"; }
e_success() { echo -e "${GREEN}✓${NC} $1"; }
e_error() { echo -e "${RED}✗${NC} $1"; }
e_warning() { echo -e "${YELLOW}!${NC} $1"; }

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Backup existing file
backup_file() {
    local file="$1"
    if [ -f "$file" ] || [ -d "$file" ]; then
        mkdir -p "$BACKUP_DIR"
        # Fix ownership if needed
        if [ ! -w "$file" ]; then
            sudo chown -R $USER:$USER "$file" 2>/dev/null || true
        fi
        mv "$file" "$BACKUP_DIR/" 2>/dev/null || {
            e_error "Failed to backup $file (permission denied)"
            return 1
        }
        e_warning "Backed up $file to $BACKUP_DIR"
    fi
}

# Create symlink
link_file() {
    local src="$1"
    local dest="$2"
    local dest_dir=$(dirname "$dest")
    
    mkdir -p "$dest_dir"
    
    if [ -e "$dest" ] && [ ! -L "$dest" ]; then
        backup_file "$dest"
    fi
    
    ln -sf "$src" "$dest"
    e_success "Linked $(basename $src)"
}

# Parse arguments
NO_PACKAGES=false
NO_SYNC=false

for arg in "$@"; do
    case $arg in
        --no-packages) NO_PACKAGES=true ;;
        --no-sync) NO_SYNC=true ;;
        --help)
            echo "Usage: ./install [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --no-packages    Skip package installation"
            echo "  --no-sync        Skip git sync"
            echo "  --help           Show this help message"
            exit 0
            ;;
    esac
done

clear
echo ""
e_header "Dotfiles Installation for Ubuntu 24.04"
echo ""

# Check if running on Ubuntu
if [ ! -f /etc/os-release ] || ! grep -q "Ubuntu" /etc/os-release; then
    e_warning "This script is designed for Ubuntu 24.04"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

cd "$DOTFILES_DIR"

# Git sync
if [ "$NO_SYNC" = false ]; then
    if [ -d .git ]; then
        e_header "Syncing dotfiles repository..."
        git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || true
        e_success "Repository synced"
    fi
fi

# Install packages
if [ "$NO_PACKAGES" = false ]; then
    e_header "Installing packages..."
    bash "$DOTFILES_DIR/scripts/install-packages"
fi

# Link dotfiles
e_header "Linking dotfiles..."

# Alacritty
# Use TOML config (v0.13+) and link theme file
link_file "$DOTFILES_DIR/alacritty/alacritty.toml" "$HOME/.config/alacritty/alacritty.toml"
link_file "$DOTFILES_DIR/alacritty/gruvbox-material-alacritty.yml" "$HOME/.config/alacritty/gruvbox-material-alacritty.yml"

# Neovim
link_file "$DOTFILES_DIR/neovim/.config/nvim" "$HOME/.config/nvim"

# Zsh
link_file "$DOTFILES_DIR/zsh/.zshrc" "$HOME/.zshrc"

# Starship
link_file "$DOTFILES_DIR/starship/starship.toml" "$HOME/.config/starship.toml"

# Zellij
link_file "$DOTFILES_DIR/zellij/config.kdl" "$HOME/.config/zellij/config.kdl"
if [ -d "$DOTFILES_DIR/zellij/themes" ]; then
    link_file "$DOTFILES_DIR/zellij/themes" "$HOME/.config/zellij/themes"
fi

# Vim
link_file "$DOTFILES_DIR/vim/.vimrc" "$HOME/.vimrc"

# Git
link_file "$DOTFILES_DIR/git/git-lazypush" "$HOME/.local/bin/git-lazypush"
chmod +x "$HOME/.local/bin/git-lazypush"

# Lazygit
link_file "$DOTFILES_DIR/lazygit/config.yml" "$HOME/.config/lazygit/config.yml"

# Yazi
link_file "$DOTFILES_DIR/yazi/yazi.toml" "$HOME/.config/yazi/yazi.toml"
link_file "$DOTFILES_DIR/yazi/theme.toml" "$HOME/.config/yazi/theme.toml"

# Zed
link_file "$DOTFILES_DIR/zed/settings.json" "$HOME/.config/zed/settings.json"

# Tilix color schemes
if command_exists tilix; then
    e_header "Installing Tilix color schemes..."
    mkdir -p "$HOME/.config/tilix/schemes"
    for scheme in "$DOTFILES_DIR/tilix/color-scheme"/*.json; do
        if [ -f "$scheme" ]; then
            link_file "$scheme" "$HOME/.config/tilix/schemes/$(basename $scheme)"
        fi
    done
    e_success "Tilix color schemes installed"
fi

# Cool Retro Term
if command_exists cool-retro-term; then
    e_header "Installing Cool Retro Term profiles..."
    mkdir -p "$HOME/.config/cool-retro-term"
    for profile in "$DOTFILES_DIR/cool-retro-terminal"/*.json; do
        if [ -f "$profile" ]; then
            link_file "$profile" "$HOME/.config/cool-retro-term/$(basename $profile)"
        fi
    done
    e_success "Cool Retro Term profiles installed"
fi

echo ""
e_success "Dotfiles linked successfully!"

# Post-install setup
e_header "Running post-install setup..."

# Install Neovim plugins
if command_exists nvim; then
    e_header "Installing Neovim plugins..."
    nvim --headless "+PlugInstall" "+qall" 2>/dev/null || true
    e_success "Neovim plugins installed"
fi

# Setup zoxide
if command_exists zoxide; then
    if ! grep -q "zoxide init" "$HOME/.zshrc"; then
        echo 'eval "$(zoxide init zsh)"' >> "$HOME/.zshrc"
        e_success "Zoxide initialized"
    fi
fi

# Setup fzf
if command_exists fzf; then
    if [ ! -f "$HOME/.fzf.zsh" ]; then
        if [ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]; then
            # Ubuntu/Debian location
            ln -sf /usr/share/doc/fzf/examples/key-bindings.zsh "$HOME/.fzf.zsh"
            e_success "FZF configured"
        fi
    fi
fi

echo ""
e_header "Installation complete!"
echo ""
echo "Next steps:"
echo "  1. Restart your terminal or run: exec zsh"
echo "  2. Run: nvim +PlugInstall +PlugUpdate +qall"
echo ""

if [ -d "$BACKUP_DIR" ]; then
    e_warning "Your old dotfiles were backed up to: $BACKUP_DIR"
fi

echo ""
